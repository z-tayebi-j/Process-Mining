<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petri Net Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        svg {
            border: 1px solid black;
        }
        circle {
            fill: lightblue;
            stroke: black;
            stroke-width: 2px;
        }
        rect {
            fill: lightgreen;
            stroke: black;
            stroke-width: 2px;
        }
        line {
            stroke: black;
            stroke-width: 2px;
        }
    </style>
</head>
<body>
    <h1>Petri Net Visualization</h1>
    <svg width="800" height="600"></svg>

    <script>
        // خواندن filename از داده‌های ارسال شده از سمت سرور
        const filename = "{{ filename }}";

        fetch(`/petri_net_data/${filename}`)
    .then(response => response.json())
    .then(data => {
        const svg = d3.select("svg");

        const places = data.places;
        const transitions = data.transitions;
        const arcs = data.arcs;

        // رسم مکان‌ها
        const placeElements = svg.selectAll("circle")
            .data(places)
            .enter()
            .append("circle")
            .attr("r", 20)
            .attr("cx", d => d.cx)
            .attr("cy", d => d.cy)
            .attr("fill", "white")
            .attr("stroke", "black")
            .attr("stroke-width", 2)
            .attr("id", d => d.id);

        // رسم انتقال‌ها
        const transitionElements = svg.selectAll("rect")
            .data(transitions)
            .enter()
            .append("rect")
            .attr("width", 60)
            .attr("height", 20)
            .attr("x", d => d.x)
            .attr("y", d => d.y)
            .attr("fill", d => d.type === 'filled' ? 'black' : 'white')
            .attr("stroke", "black")
            .attr("stroke-width", 2)
            .attr("id", d => d.id);

        // رسم یال‌ها
        svg.selectAll("line")
            .data(arcs)
            .enter()
            .append("line")
            .attr("x1", d => getCoordinates(d.source).x)
            .attr("y1", d => getCoordinates(d.source).y)
            .attr("x2", d => getCoordinates(d.target).x)
            .attr("y2", d => getCoordinates(d.target).y)
            .attr("stroke", "black")
            .attr("marker-end", "url(#arrow)");

        // تعریف marker برای نمایش فلش یال‌ها
        svg.append("defs").append("marker")
            .attr("id", "arrow")
            .attr("viewBox", "0 0 10 10")
            .attr("refX", 5)
            .attr("refY", 5)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto-start-reverse")
            .append("path")
            .attr("d", "M 0 0 L 10 5 L 0 10 z")
            .attr("fill", "black");

        // تابعی برای پیدا کردن مختصات مکان‌ها و انتقال‌ها بر اساس id آن‌ها
        function getCoordinates(id) {
            const place = svg.select(`#${id}`);
            if (!place.empty()) {
                return {
                    x: +place.attr("cx"),
                    y: +place.attr("cy")
                };
            }
            const transition = svg.select(`#${id}`);
            if (!transition.empty()) {
                return {
                    x: +transition.attr("x") + 30, // وسط مستطیل
                    y: +transition.attr("y") + 10  // وسط مستطیل
                };
            }
            return {x: 0, y: 0};  // اگر پیدا نشد
        }
    });

    </script>
</body>
</html>
